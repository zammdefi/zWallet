<!DOCTYPE html>
<html>
<head>
    <title>USDC IOU Verification</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.15.0/ethers.umd.min.js"></script>
</head>
<body>
    <h1>USDC IOU Domain Separator Verification</h1>
    <pre id="output"></pre>
    
    <script>
        async function verify() {
            const output = [];
            
            // Ethereum USDC domain
            const ethDomain = {
                name: 'USD Coin',
                version: '2',
                chainId: 1,
                verifyingContract: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48'
            };
            
            // Base USDC domain
            const baseDomain = {
                name: 'USD Coin',
                version: '2',
                chainId: 8453,
                verifyingContract: '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913'
            };
            
            // Calculate domain separators
            const ethSeparator = ethers.TypedDataEncoder.hashDomain(ethDomain);
            const baseSeparator = ethers.TypedDataEncoder.hashDomain(baseDomain);
            
            output.push('=== USDC Domain Separator Verification ===\n');
            
            output.push('Ethereum USDC Configuration:');
            output.push('  Name: USD Coin');
            output.push('  Version: 2');
            output.push('  Chain ID: 1');
            output.push('  Contract: 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48');
            output.push(`  Calculated Separator: ${ethSeparator}\n`);
            
            output.push('Base USDC Configuration:');
            output.push('  Name: USD Coin');
            output.push('  Version: 2');
            output.push('  Chain ID: 8453');
            output.push('  Contract: 0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913');
            output.push(`  Calculated Separator: ${baseSeparator}`);
            output.push(`  Expected Separator:   0x02fa7265e7c5d81118673727957699e4d68f74cd74b7db77da710fe8a2c7834f`);
            output.push(`  ✅ Match: ${baseSeparator === '0x02fa7265e7c5d81118673727957699e4d68f74cd74b7db77da710fe8a2c7834f'}\n`);
            
            // Test signature generation
            output.push('=== Test Signature Generation ===\n');
            
            // Create a test wallet
            const testWallet = ethers.Wallet.createRandom();
            output.push(`Test Wallet: ${testWallet.address}`);
            
            // Create test IOU message
            const testMessage = {
                from: testWallet.address,
                to: '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb0',
                value: ethers.parseUnits('100', 6).toString(), // 100 USDC
                validAfter: '0',
                validBefore: Math.floor(Date.now() / 1000 + 86400).toString(), // 1 day
                nonce: ethers.hexlify(ethers.randomBytes(32))
            };
            
            output.push('\nTest IOU Message:');
            output.push(JSON.stringify(testMessage, null, 2));
            
            // Sign for both networks
            const types = {
                TransferWithAuthorization: [
                    { name: 'from', type: 'address' },
                    { name: 'to', type: 'address' },
                    { name: 'value', type: 'uint256' },
                    { name: 'validAfter', type: 'uint256' },
                    { name: 'validBefore', type: 'uint256' },
                    { name: 'nonce', type: 'bytes32' }
                ]
            };
            
            // Ethereum signature
            const ethSignature = await testWallet.signTypedData(ethDomain, types, testMessage);
            output.push('\nEthereum Signature:');
            output.push(`  ${ethSignature}`);
            
            // Verify Ethereum signature
            const ethRecovered = ethers.verifyTypedData(ethDomain, types, testMessage, ethSignature);
            output.push(`  Recovered: ${ethRecovered}`);
            output.push(`  ✅ Valid: ${ethRecovered.toLowerCase() === testWallet.address.toLowerCase()}`);
            
            // Base signature
            const baseSignature = await testWallet.signTypedData(baseDomain, types, testMessage);
            output.push('\nBase Signature:');
            output.push(`  ${baseSignature}`);
            
            // Verify Base signature
            const baseRecovered = ethers.verifyTypedData(baseDomain, types, testMessage, baseSignature);
            output.push(`  Recovered: ${baseRecovered}`);
            output.push(`  ✅ Valid: ${baseRecovered.toLowerCase() === testWallet.address.toLowerCase()}`);
            
            output.push('\n=== Verification Complete ===');
            output.push('\n✅ Both networks produce valid, verifiable signatures');
            output.push('✅ Base domain separator matches expected value');
            output.push('✅ EIP-3009 TransferWithAuthorization structure is correct');
            
            document.getElementById('output').textContent = output.join('\n');
        }
        
        verify().catch(console.error);
    </script>
</body>
</html>